<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="sendingBox.css">
</head>
<body>
    <header>

        <div class="container">
    
            <div class="profile">
    
                <div class="profile-image">
    
                    <img src="" alt="" id="userAvatar" style="width: 152px; aspect-ratio: 1; border: 2px solid gray;">
    
                </div>
    
                <div class="profile-user-settings">
    
                    <h1 class="profile-user-name" id="username"></h1>
    
                    <button class="btn profile-edit-btn" id="edit">Edit Profile</button>
                    <button class="btn profile-edit-btn" id="_posts">Edit posts</button>
                    <!-- New sending box -->
                    <div class="login-box"  id="wrapper">
                        <h2>Edit post</h2>
                        <form>
                          <div class="user-box">
                            <input type="text" name="" required="" id="title">
                            <label>Title</label>
                          </div>
                          <div class="user-box">
                            <input type="text" name="" required="" id="description">
                            <label>Description</label>
                          </div>
                          <div class="user-box">
                            <input type="text" name="" required="" id="status">
                            <label>Status</label>
                          </div>
                          <div class="user-box">
                            <input type="text" name="" required="" id="image">
                            <label>Image</label>
                          </div>
                          <a href="#" id="sendPost">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span></span>
                            Send
                          </a>
                        </form>
                      </div>
                      <!-- End of new sending box -->
                    <button class="btn profile-edit-btn" id="logout">Log out</button>
                    <button class="btn profile-edit-btn" id="delete" style="border-color: red; color: red;">Delete account</button>
                    <button class="btn profile-settings-btn" aria-label="profile settings"><i class="fas fa-cog" aria-hidden="true"></i></button>
    
                </div>
    
                <div class="profile-stats">
    
                    <ul>
                        <li><span class="profile-stat-count">164</span> posts</li>
                        <li><span class="profile-stat-count">188</span> followers</li>
                        <li><span class="profile-stat-count">206</span> following</li>
                    </ul>
    
                </div>
    
                <div class="profile-bio">
                    <span class="profile-real-name" id="fullname"></span>
                    <span id="userBio"></span>
    
                </div>
    
            </div>
            <!-- End of profile section -->
    
        </div>
        <!-- End of container -->
    
    </header>
    
    <main>
    
        <div class="container">
    
            <div class="gallery" id="items">

            </div>
            <!-- End of gallery -->
    
            <div class="loader"></div>
    
        </div>
        <!-- End of container -->
    
    </main>
    <script src="requests.js"></script>
    <script src="helpers.js"></script>
    <script>
        /*

Full-page view:

https://codepen.io/GeorgePark/full/VXrwOP/

*/
let _headers = {
            "Content-type" : "application/json",
            "Access-Control-Allow-Origin": "*",
            "User-Agent" : "telran",
            "ngrok-skip-browser-warning": "69420",
            "x-access-token" : localStorage.getItem("token")
};
let url = "http://65.109.13.139:9191";
const posts = document.querySelectorAll('.gallery-item');

posts.forEach(post => {
	post.addEventListener('click', () => {
		//Get original image URL
		const imgUrl = post.firstElementChild.src.split("?")[0];
		//Open image in new tab
		window.open(imgUrl, '_blank');
	});
});
document.getElementById("logout").addEventListener("click", function () 
{
    try {
        new Promise((resolve, reject) => {
            resolve();
        }).then(function(){
            return logOut();
        }).then(function() {
            location.href = 'login.html';
        })
    } catch (error) {
        location.href = '404.html';
    }
});
document.getElementById("delete").addEventListener("click", function () 
{
    try {
        new Promise((resolve, reject) => {
            resolve();
        }).then(function(){
            return deleteAccount();
        }).then(function() {
            location.href = 'login.html';
        })
    } catch (error) {
        location.href = '404.html';
    }
});
document.getElementById("edit").addEventListener("click", function () 
{
    try {
        newInfo();
    } catch (error) {
        location.href = '404.html';
    }
});
document.getElementById("sendPost").addEventListener("click", function () 
{
    if(document.getElementById("title").value == "") {
        document.getElementById("wrapper").style.visibility = 'hidden';
    }
    else{
        try {
        _posts();
    } catch (error) {
        location.href = '404.html';
    }
    }
});
document.getElementById("_posts").addEventListener("click", function () 
{
    document.getElementById("wrapper").style.visibility = 'visible';
});
function newInfo(){
    fetch(url + "/me", {
        method: 'PUT',
        headers: {
            "Content-type" : "application/json",
            "Access-Control-Allow-Origin": "*",
            "User-Agent" : "telran",
            "ngrok-skip-browser-warning": "69420",
            "x-access-token" : localStorage.getItem("token")
        },
        body: JSON.stringify({
            "avatar": "https://gravatar.com/avatar/a91426f0e0178ab184d31c537fa434ed?s=400&d=robohash&r=x",
            "age": "23",
            "bio": "Am student in Tel-Ran",
            "fullName": "Volodymyr Ziubrytskyi"
        })
    }).then (data => data.json())
    .then(data => {
        console.log("ID is: ", data._id);
        console.log("Name is: ", data.username);
        console.log("Age is: ", data.age);
        console.log("Avatar is: ", data.avatar);
    });
}
(function (){
    requests.prototype.get(`${url}/me`, showMe);
    requests.prototype.get(`${url}/posts`, postShow);
}())
async function logOut()
{
    await requests.prototype.logout(`${url}/destroy-session`);
    clearStorage();
}
async function deleteAccount(){
    await requests.prototype.delete(`${url}/me`);
    clearStorage();
}
function _posts(){
    fetch(url + "/post", {
        method: 'POST',
        headers: _headers,
        body: JSON.stringify({
            "title": document.getElementById("title").value,
            "description": document.getElementById("description").value,
            "status": document.getElementById("status").value,
            "image": document.getElementById("image").value
        })
    }).then(function(){
        document.getElementById("wrapper").style.visibility = 'hidden';
    })
}
// var parent = document.getElementById('items');
// var child_nodes = parent.childNodes;
// console.log(child_nodes);
// let a = document.getElementsByClassName("gallery-image");
// console.log(a);
let selectedImg;
document.getElementById("items").onclick = function(event){
    let target = event.target;
    if(target.tagName != 'IMG') return;
    _openIMG(target);
};
function _openIMG(img){
    selectedImg = img;
    console.log(selectedImg.id);
    fetch(url + "/post/" + selectedImg.id, {
        method: 'GET',
        headers: {
            "Content-type" : "application/json",
            "Access-Control-Allow-Origin": "*",
            "User-Agent" : "telran",
            "ngrok-skip-browser-warning": "69420",
            "x-access-token" : localStorage.getItem("token"),
            "_id" : selectedImg.id
        }
    }).then((data) => {
        return data.json();
    }).then((data) => {
        location.href = data.image;
    });
}
// function _postsID(){
//     fetch(url + "/post/{_id}", {
//         method: 'GET',
//         headers: {
//             "Content-type" : "application/json",
//             "Access-Control-Allow-Origin": "*",
//             "User-Agent" : "telran",
//             "ngrok-skip-browser-warning": "69420",
//             "x-access-token" : localStorage.getItem("token"),
//             "_id" : document.getElementsByTagName("img").id
//         }
//     }).then(console.log(document.getElementsByTagName("img").id))
// }
    </script>
</body>
</html>